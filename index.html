<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitSquad Pro - 20K DH Challenge</title>
    
    <!-- Firebase SDKs v8 (more stable for basic projects) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --primary-color: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary-color: #64748b;
            --success-color: #059669;
            --warning-color: #d97706;
            --error-color: #dc2626;
            --background-color: #f8fafc;
            --surface-color: #ffffff;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --border-color: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --radius: 12px;
            --transition: all 0.2s ease-in-out;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--background-color);
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* Authentication Styles */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }

        .auth-card {
            background: var(--surface-color);
            border-radius: 20px;
            padding: 40px;
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .auth-logo {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-color), #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .auth-subtitle {
            color: var(--text-secondary);
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius);
            font-size: 16px;
            transition: var(--transition);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            width: 100%;
            font-size: 16px;
        }

        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--secondary-color);
            margin-top: 12px;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .auth-divider {
            margin: 24px 0;
            text-align: center;
            position: relative;
            color: var(--text-secondary);
        }

        .auth-divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--border-color);
        }

        .auth-divider span {
            background: var(--surface-color);
            padding: 0 16px;
        }

        /* Main App Styles */
        .app-container {
            display: none;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: var(--surface-color);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-content h1 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .header-stats {
            display: flex;
            gap: 24px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .nav-tabs {
            display: flex;
            background: var(--surface-color);
            border-radius: var(--radius);
            padding: 8px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            overflow-x: auto;
        }

        .nav-tab {
            padding: 12px 20px;
            border-radius: 8px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-secondary);
            transition: var(--transition);
            white-space: nowrap;
            flex: 1;
        }

        .nav-tab.active {
            background: var(--primary-color);
            color: white;
        }

        .nav-tab:hover:not(.active) {
            background: var(--background-color);
            color: var(--text-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }

        .card {
            background: var(--surface-color);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
        }

        .card-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            line-height: 1;
        }

        .metric-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            margin: 16px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--success-color));
            transition: width 0.5s ease;
        }

        .leaderboard {
            background: var(--surface-color);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow);
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            margin: 8px 0;
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }

        .leaderboard-item:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .leaderboard-item.rank-1 {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            border-color: #d97706;
        }

        .leaderboard-item.rank-2 {
            background: linear-gradient(135deg, #e5e7eb, #9ca3af);
            color: white;
            border-color: #6b7280;
        }

        .leaderboard-item.rank-3 {
            background: linear-gradient(135deg, #cd7c2f, #b45309);
            color: white;
            border-color: #92400e;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-stats {
            text-align: right;
        }

        .user-score {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .user-streak {
            font-size: 0.875rem;
            opacity: 0.8;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 20px;
        }

        .action-btn {
            padding: 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius);
            background: var(--surface-color);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            text-align: center;
        }

        .action-btn:hover {
            border-color: var(--primary-color);
            background: #eff6ff;
        }

        .action-btn.active {
            background: var(--success-color);
            border-color: var(--success-color);
            color: white;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--surface-color);
            border-radius: var(--radius);
            padding: 16px 20px;
            box-shadow: var(--shadow-lg);
            border-left: 4px solid var(--success-color);
            z-index: 1000;
            animation: slideIn 0.3s ease;
            max-width: 350px;
        }

        .notification.error {
            border-left-color: var(--error-color);
        }

        .notification.warning {
            border-left-color: var(--warning-color);
        }

        .firebase-status {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 1000;
            background: var(--success-color);
            color: white;
        }

        .firebase-status.offline {
            background: var(--error-color);
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }

        .chart-container {
            background: var(--surface-color);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow);
            min-height: 300px;
        }

        .hidden {
            display: none !important;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }
            
            .header-stats {
                flex-wrap: wrap;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Firebase Connection Status -->
    <div id="firebaseStatus" class="firebase-status">
        <span id="statusText">Connecting...</span>
    </div>

    <!-- Authentication Screen -->
    <div id="authContainer" class="auth-container">
        <div class="auth-card">
            <h1 class="auth-logo">FitSquad Pro</h1>
            <p class="auth-subtitle">Join the 20K DH Challenge</p>
            
            <!-- Login Form -->
            <div id="loginForm">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="loginEmail" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="loginPassword" placeholder="Enter your password">
                </div>
                <button class="btn" onclick="loginUser()">Sign In</button>
                <button class="btn btn-secondary" onclick="showRegisterForm()">Create Account</button>
                
                <div class="auth-divider">
                    <span>or</span>
                </div>
                
                <button class="btn btn-secondary" onclick="signInWithGoogle()">
                    Sign in with Google
                </button>
            </div>
            
            <!-- Register Form -->
            <div id="registerForm" class="hidden">
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" class="form-input" id="registerName" placeholder="Enter your full name">
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="registerEmail" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="registerPassword" placeholder="Create a password">
                </div>
                <div class="form-group">
                    <label class="form-label">Squad Nickname</label>
                    <input type="text" class="form-input" id="registerNickname" placeholder="e.g., The Beast, The Machine">
                </div>
                <button class="btn" onclick="registerUser()">Create Account</button>
                <button class="btn btn-secondary" onclick="showLoginForm()">Back to Sign In</button>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="app-container">
        <div class="header">
            <div class="header-content">
                <h1>FitSquad Pro Challenge</h1>
                <div class="header-stats">
                    <span>💰 Prize: 20,000 DH</span>
                    <span id="globalProgress">Progress: 9.6%</span>
                    <span id="daysRemaining">Days left: 330</span>
                    <span id="currentLeader">Leader: Loading...</span>
                </div>
            </div>
            <div class="user-menu">
                <div class="user-avatar" id="userAvatar">U</div>
                <span id="userName">User</span>
                <button class="btn" onclick="signOut()" style="width: auto; padding: 8px 16px;">Sign Out</button>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">Dashboard</button>
            <button class="nav-tab" onclick="showTab('progress')">Progress</button>
            <button class="nav-tab" onclick="showTab('leaderboard')">Leaderboard</button>
            <button class="nav-tab" onclick="showTab('analytics')">Analytics</button>
            <button class="nav-tab" onclick="showTab('social')">Feed</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="dashboard-grid">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Your Progress</h3>
                    </div>
                    <div class="metric-value" id="userScore">0</div>
                    <div class="metric-label">Total Points</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="userProgressBar" style="width: 0%"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 0.875rem; color: var(--text-secondary);">
                        <span>Current Streak: <span id="userStreak">0</span> days</span>
                        <span>Rank: #<span id="userRank">-</span></span>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Quick Check-in</h3>
                    </div>
                    <div class="quick-actions">
                        <div class="action-btn" onclick="quickCheckIn('workout')">
                            💪 Workout
                        </div>
                        <div class="action-btn" onclick="quickCheckIn('nutrition')">
                            🥗 Nutrition
                        </div>
                        <div class="action-btn" onclick="quickCheckIn('sleep')">
                            😴 Sleep
                        </div>
                        <div class="action-btn" onclick="quickCheckIn('hydration')">
                            💧 Hydration
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Team Stats</h3>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <div class="metric-value" id="teamAverage">0</div>
                            <div class="metric-label">Team Average</div>
                        </div>
                        <div>
                            <div class="metric-value" id="teamActive">0</div>
                            <div class="metric-label">Active Today</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progress Tab -->
        <div id="progress" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Log Your Progress</h3>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                    <div class="form-group">
                        <label class="form-label">Weight (kg)</label>
                        <input type="number" class="form-input" id="weightInput" placeholder="Enter weight" step="0.1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Body Fat %</label>
                        <input type="number" class="form-input" id="bodyfatInput" placeholder="Enter body fat %" step="0.1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Energy Level (1-10)</label>
                        <input type="number" class="form-input" id="energyInput" placeholder="Rate your energy" min="1" max="10">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Sleep Hours</label>
                        <input type="number" class="form-input" id="sleepInput" placeholder="Hours slept" step="0.5">
                    </div>
                </div>
                <button class="btn" onclick="saveProgress()" style="margin-top: 16px;">Save Progress</button>
            </div>

            <div class="analytics-grid">
                <div class="chart-container">
                    <h4>Weight Trend</h4>
                    <canvas id="weightChart" width="400" height="200"></canvas>
                </div>
                <div class="chart-container">
                    <h4>Daily Score</h4>
                    <canvas id="scoreChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- Leaderboard Tab -->
        <div id="leaderboard" class="tab-content">
            <div class="leaderboard">
                <h2 class="card-title" style="text-align: center; margin-bottom: 24px;">Live Rankings</h2>
                <div id="leaderboardContainer">
                    <!-- Leaderboard items will be populated here -->
                </div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics" class="tab-content">
            <div class="dashboard-grid">
                <div class="card">
                    <h3 class="card-title">Performance Metrics</h3>
                    <div id="performanceMetrics">
                        <!-- Metrics will be populated here -->
                    </div>
                </div>
                <div class="card">
                    <h3 class="card-title">Consistency Score</h3>
                    <div class="metric-value" id="consistencyScore">0%</div>
                    <div class="metric-label">Based on daily check-ins</div>
                </div>
                <div class="card">
                    <h3 class="card-title">Predictions</h3>
                    <div id="predictions">
                        <p>AI analysis based on your progress patterns...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Social Tab -->
        <div id="social" class="tab-content">
            <div class="card">
                <h3 class="card-title">Team Feed</h3>
                <div class="form-group">
                    <textarea class="form-input" id="postInput" rows="3" placeholder="Share your progress, motivation, or achievements..."></textarea>
                </div>
                <button class="btn" onclick="createPost()">Share Update</button>
                
                <div id="feedContainer" style="margin-top: 24px;">
                    <!-- Feed posts will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration - Your actual config
        const firebaseConfig = {
            apiKey: "AIzaSyBYXcm6oJNsTLnRyLB8hv7tmOCX6QOFTyw",
            authDomain: "fitness-tracker-eff06.firebaseapp.com",
            databaseURL: "https://fitness-tracker-eff06-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "fitness-tracker-eff06",
            storageBucket: "fitness-tracker-eff06.firebasestorage.app",
            messagingSenderId: "560968111406",
            appId: "1:560968111406:web:4544427ef3464cde3896bf",
            measurementId: "G-QCVWJM25GF"
        };

        // Initialize Firebase
        let app, auth, database, storage;
        let currentUser = null;
        let userData = {};
        let leaderboardData = {};

        function initializeFirebase() {
            try {
                // Initialize Firebase with v8 SDK
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                database = firebase.database();
                storage = firebase.storage();
                
                updateFirebaseStatus('connected');
                console.log('✅ Firebase initialized successfully');
                
                // Set up auth state listener
                auth.onAuthStateChanged(handleAuthStateChange);
                
                return true;
            } catch (error) {
                console.error('❌ Firebase initialization error:', error);
                updateFirebaseStatus('error');
                return false;
            }
        }

        function updateFirebaseStatus(status) {
            const statusElement = document.getElementById('firebaseStatus');
            const statusText = document.getElementById('statusText');
            
            switch (status) {
                case 'connected':
                    statusElement.className = 'firebase-status';
                    statusText.textContent = '🔥 Connected';
                    break;
                case 'offline':
                    statusElement.className = 'firebase-status offline';
                    statusText.textContent = '⚠️ Offline';
                    break;
                case 'error':
                    statusElement.className = 'firebase-status offline';
                    statusText.textContent = '❌ Error';
                    break;
                default:
                    statusText.textContent = 'Connecting...';
            }
        }

        // Authentication Functions
        function showLoginForm() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
        }

        function showRegisterForm() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }

        async function loginUser() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showNotification('Please fill in all fields', 'error');
                return;
            }

            if (!auth) {
                showNotification('Firebase not initialized. Please refresh the page.', 'error');
                return;
            }

            try {
                const result = await auth.signInWithEmailAndPassword(email, password);
                showNotification('Welcome back! 🎉', 'success');
                console.log('User signed in:', result.user.uid);
            } catch (error) {
                console.error('Login error:', error);
                let errorMessage = 'Login failed';
                
                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMessage = 'No account found with this email';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = 'Incorrect password';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Invalid email address';
                        break;
                    case 'auth/user-disabled':
                        errorMessage = 'This account has been disabled';
                        break;
                    default:
                        errorMessage = error.message;
                }
                
                showNotification(errorMessage, 'error');
            }
        }

        async function registerUser() {
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const nickname = document.getElementById('registerNickname').value;
            
            if (!name || !email || !password || !nickname) {
                showNotification('Please fill in all fields', 'error');
                return;
            }

            if (password.length < 6) {
                showNotification('Password must be at least 6 characters', 'error');
                return;
            }

            if (!auth) {
                showNotification('Firebase not initialized. Please refresh the page.', 'error');
                return;
            }

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Update user profile
                await user.updateProfile({
                    displayName: name
                });
                
                // Create user data in database
                const initialUserData = {
                    uid: user.uid,
                    name: name,
                    nickname: nickname,
                    email: email,
                    score: 0,
                    streak: 0,
                    joinDate: new Date().toISOString(),
                    lastActive: new Date().toISOString(),
                    checkIns: {},
                    progressData: [],
                    isOnline: true
                };
                
                await database.ref(`users/${user.uid}`).set(initialUserData);
                showNotification('Account created successfully! 🎉', 'success');
                console.log('User registered:', user.uid);
                
            } catch (error) {
                console.error('Registration error:', error);
                let errorMessage = 'Registration failed';
                
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = 'An account with this email already exists';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Invalid email address';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'Password is too weak';
                        break;
                    default:
                        errorMessage = error.message;
                }
                
                showNotification(errorMessage, 'error');
            }
        }

        async function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            
            try {
                const result = await auth.signInWithPopup(provider);
                const user = result.user;
                
                // Check if user exists in database
                const userSnapshot = await database.ref(`users/${user.uid}`).once('value');
                
                if (!userSnapshot.exists()) {
                    // Create new user data
                    const nickname = prompt('Enter your squad nickname (e.g., The Beast, The Machine):') || 'Challenger';
                    
                    const initialUserData = {
                        uid: user.uid,
                        name: user.displayName,
                        nickname: nickname,
                        email: user.email,
                        photoURL: user.photoURL,
                        score: 0,
                        streak: 0,
                        joinDate: new Date().toISOString(),
                        lastActive: new Date().toISOString(),
                        checkIns: {},
                        progressData: [],
                        isOnline: true
                    };
                    
                    await database.ref(`users/${user.uid}`).set(initialUserData);
                }
                
                showNotification('Welcome to FitSquad Pro! 🎉', 'success');
                
            } catch (error) {
                console.error('Google sign-in error:', error);
                showNotification('Google sign-in failed: ' + error.message, 'error');
            }
        }

        async function signOut() {
            try {
                // Update user offline status
                if (currentUser) {
                    await database.ref(`users/${currentUser.uid}/isOnline`).set(false);
                }
                
                await auth.signOut();
                showNotification('Signed out successfully', 'success');
            } catch (error) {
                console.error('Sign out error:', error);
                showNotification('Error signing out', 'error');
            }
        }

        function handleAuthStateChange(user) {
            if (user) {
                currentUser = user;
                showMainApp();
                loadUserData();
                setupRealtimeListeners();
                updateUserOnlineStatus(true);
            } else {
                currentUser = null;
                showAuthScreen();
                cleanupListeners();
            }
        }

        function showAuthScreen() {
            document.getElementById('authContainer').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
        }

        function showMainApp() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
        }

        // User Data Management
        async function loadUserData() {
            if (!currentUser) return;
            
            try {
                const snapshot = await database.ref(`users/${currentUser.uid}`).once('value');
                if (snapshot.exists()) {
                    userData = snapshot.val();
                    updateUserInterface();
                }
                
                // Load leaderboard data
                loadLeaderboard();
                
            } catch (error) {
                console.error('Error loading user data:', error);
                showNotification('Error loading data', 'error');
            }
        }

        function updateUserInterface() {
            if (!userData) return;
            
            // Update user info in header
            document.getElementById('userName').textContent = userData.name || 'User';
            document.getElementById('userAvatar').textContent = (userData.name || 'U').charAt(0).toUpperCase();
            
            // Update dashboard metrics
            document.getElementById('userScore').textContent = userData.score || 0;
            document.getElementById('userStreak').textContent = userData.streak || 0;
            
            // Update progress bar
            const maxScore = 1000; // Adjust based on your scoring system
            const progressPercentage = Math.min(100, (userData.score / maxScore) * 100);
            document.getElementById('userProgressBar').style.width = progressPercentage + '%';
            
            // Update today's check-ins
            updateCheckInButtons();
            
            // Update consistency score
            updateConsistencyScore();
        }

        async function updateUserOnlineStatus(isOnline) {
            if (!currentUser) return;
            
            try {
                await database.ref(`users/${currentUser.uid}/isOnline`).set(isOnline);
                if (isOnline) {
                    await database.ref(`users/${currentUser.uid}/lastActive`).set(new Date().toISOString());
                }
            } catch (error) {
                console.error('Error updating online status:', error);
            }
        }

        // Real-time Data Listeners
        let listeners = [];

        function setupRealtimeListeners() {
            if (!currentUser) return;
            
            // Listen to user data changes
            const userListener = database.ref(`users/${currentUser.uid}`).on('value', (snapshot) => {
                if (snapshot.exists()) {
                    userData = snapshot.val();
                    updateUserInterface();
                }
            });
            
            // Listen to leaderboard changes
            const leaderboardListener = database.ref('users').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    leaderboardData = snapshot.val();
                    updateLeaderboard();
                    updateTeamStats();
                }
            });
            
            listeners.push(
                { ref: `users/${currentUser.uid}`, listener: userListener },
                { ref: 'users', listener: leaderboardListener }
            );
        }

        function cleanupListeners() {
            listeners.forEach(({ ref, listener }) => {
                database.ref(ref).off('value', listener);
            });
            listeners = [];
        }

        // Check-in Functions
        async function quickCheckIn(type) {
            if (!currentUser) return;
            
            const today = new Date().toDateString();
            const checkInPath = `users/${currentUser.uid}/checkIns/${today}/${type}`;
            
            try {
                const snapshot = await database.ref(checkInPath).once('value');
                const isCheckedIn = snapshot.exists();
                
                if (isCheckedIn) {
                    // Remove check-in
                    await database.ref(checkInPath).remove();
                    await database.ref(`users/${currentUser.uid}/score`).transaction((score) => {
                        return Math.max(0, (score || 0) - 10);
                    });
                    showNotification(`${type} check-in removed`, 'warning');
                } else {
                    // Add check-in
                    await database.ref(checkInPath).set(true);
                    await database.ref(`users/${currentUser.uid}/score`).transaction((score) => {
                        return (score || 0) + 10;
                    });
                    
                    // Update streak
                    await updateStreak();
                    
                    showNotification(`Great job! +10 points for ${type}! 🎉`, 'success');
                }
                
                // Update last active
                await database.ref(`users/${currentUser.uid}/lastActive`).set(new Date().toISOString());
                
            } catch (error) {
                console.error('Check-in error:', error);
                showNotification('Error updating check-in', 'error');
            }
        }

        function updateCheckInButtons() {
            if (!userData.checkIns) return;
            
            const today = new Date().toDateString();
            const todayCheckIns = userData.checkIns[today] || {};
            
            ['workout', 'nutrition', 'sleep', 'hydration'].forEach(type => {
                const button = document.querySelector(`[onclick="quickCheckIn('${type}')"]`);
                if (button) {
                    if (todayCheckIns[type]) {
                        button.classList.add('active');
                    } else {
                        button.classList.remove('active');
                    }
                }
            });
        }

        async function updateStreak() {
            if (!currentUser) return;
            
            try {
                const checkInsSnapshot = await database.ref(`users/${currentUser.uid}/checkIns`).once('value');
                const checkInsData = checkInsSnapshot.val() || {};
                
                let currentStreak = 0;
                const today = new Date();
                
                // Calculate streak by checking consecutive days
                for (let i = 0; i <= 365; i++) {
                    const checkDate = new Date(today);
                    checkDate.setDate(checkDate.getDate() - i);
                    const dateString = checkDate.toDateString();
                    
                    const dayCheckIns = checkInsData[dateString];
                    if (dayCheckIns && Object.keys(dayCheckIns).length > 0) {
                        currentStreak++;
                    } else {
                        break;
                    }
                }
                
                await database.ref(`users/${currentUser.uid}/streak`).set(currentStreak);
                
            } catch (error) {
                console.error('Error updating streak:', error);
            }
        }

        // Progress Tracking
        async function saveProgress() {
            if (!currentUser) return;
            
            const weight = parseFloat(document.getElementById('weightInput').value);
            const bodyfat = parseFloat(document.getElementById('bodyfatInput').value);
            const energy = parseInt(document.getElementById('energyInput').value);
            const sleep = parseFloat(document.getElementById('sleepInput').value);
            
            if (!weight) {
                showNotification('Please enter your weight', 'warning');
                return;
            }
            
            const progressEntry = {
                date: new Date().toISOString(),
                weight: weight,
                bodyfat: bodyfat || null,
                energy: energy || null,
                sleep: sleep || null
            };
            
            try {
                await database.ref(`users/${currentUser.uid}/progressData`).push(progressEntry);
                await database.ref(`users/${currentUser.uid}/score`).transaction((score) => {
                    return (score || 0) + 15;
                });
                await database.ref(`users/${currentUser.uid}/lastActive`).set(new Date().toISOString());
                
                showNotification('Progress saved! +15 points! 📊', 'success');
                
                // Clear form
                document.getElementById('weightInput').value = '';
                document.getElementById('bodyfatInput').value = '';
                document.getElementById('energyInput').value = '';
                document.getElementById('sleepInput').value = '';
                
                // Update charts
                updateProgressCharts();
                
            } catch (error) {
                console.error('Error saving progress:', error);
                showNotification('Error saving progress', 'error');
            }
        }

        // Leaderboard Functions
        async function loadLeaderboard() {
            try {
                const snapshot = await database.ref('users').once('value');
                if (snapshot.exists()) {
                    leaderboardData = snapshot.val();
                    updateLeaderboard();
                    updateTeamStats();
                }
            } catch (error) {
                console.error('Error loading leaderboard:', error);
            }
        }

        function updateLeaderboard() {
            const container = document.getElementById('leaderboardContainer');
            if (!container || !leaderboardData) return;
            
            // Convert to array and sort by score
            const users = Object.values(leaderboardData)
                .filter(user => user.score !== undefined)
                .sort((a, b) => (b.score || 0) - (a.score || 0));
            
            container.innerHTML = '';
            
            users.forEach((user, index) => {
                const rank = index + 1;
                const isCurrentUser = user.uid === currentUser?.uid;
                
                const item = document.createElement('div');
                item.className = `leaderboard-item ${rank <= 3 ? `rank-${rank}` : ''}`;
                
                const avatar = user.photoURL ? 
                    `<img src="${user.photoURL}" alt="${user.name}" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">` :
                    `<div class="user-avatar" style="width: 50px; height: 50px; font-size: 1.2rem;">${(user.name || 'U').charAt(0).toUpperCase()}</div>`;
                
                const onlineStatus = user.isOnline ? 
                    '<span style="color: #10b981; font-size: 0.8rem;">🟢 Online</span>' : '';
                
                item.innerHTML = `
                    <div class="user-info">
                        ${avatar}
                        <div>
                            <strong>${user.name || 'Unknown'}</strong>
                            <div style="font-size: 0.9rem; opacity: 0.8;">${user.nickname || ''}</div>
                            ${onlineStatus}
                        </div>
                    </div>
                    <div class="user-stats">
                        <div class="user-score">${user.score || 0}</div>
                        <div class="user-streak">${user.streak || 0}-day streak</div>
                    </div>
                `;
                
                if (isCurrentUser) {
                    item.style.borderColor = 'var(--primary-color)';
                    item.style.backgroundColor = '#eff6ff';
                    document.getElementById('userRank').textContent = rank;
                }
                
                container.appendChild(item);
            });
            
            // Update header with current leader
            if (users.length > 0) {
                document.getElementById('currentLeader').textContent = `Leader: ${users[0].name}`;
            }
        }

        function updateTeamStats() {
            if (!leaderboardData) return;
            
            const users = Object.values(leaderboardData);
            const totalUsers = users.length;
            
            // Calculate team average
            const totalScore = users.reduce((sum, user) => sum + (user.score || 0), 0);
            const teamAverage = totalUsers > 0 ? Math.round(totalScore / totalUsers) : 0;
            
            // Calculate active today
            const today = new Date().toDateString();
            const activeToday = users.filter(user => {
                const lastActive = new Date(user.lastActive || 0);
                return lastActive.toDateString() === today;
            }).length;
            
            document.getElementById('teamAverage').textContent = teamAverage;
            document.getElementById('teamActive').textContent = activeToday;
        }

        // Social Features
        async function createPost() {
            const postText = document.getElementById('postInput').value.trim();
            if (!postText || !currentUser) return;
            
            const post = {
                id: Date.now().toString(),
                authorId: currentUser.uid,
                authorName: userData.name || 'Unknown',
                authorPhoto: userData.photoURL || null,
                text: postText,
                timestamp: new Date().toISOString(),
                likes: 0,
                comments: []
            };
            
            try {
                await database.ref(`posts/${post.id}`).set(post);
                await database.ref(`users/${currentUser.uid}/score`).transaction((score) => {
                    return (score || 0) + 5;
                });
                
                document.getElementById('postInput').value = '';
                showNotification('Post shared! +5 points! 📝', 'success');
                
                loadSocialFeed();
                
            } catch (error) {
                console.error('Error creating post:', error);
                showNotification('Error sharing post', 'error');
            }
        }

        async function loadSocialFeed() {
            try {
                const snapshot = await database.ref('posts').orderByChild('timestamp').limitToLast(20).once('value');
                const posts = [];
                
                snapshot.forEach((childSnapshot) => {
                    posts.push(childSnapshot.val());
                });
                
                posts.reverse(); // Show newest first
                
                const container = document.getElementById('feedContainer');
                container.innerHTML = '';
                
                posts.forEach(post => {
                    const postElement = document.createElement('div');
                    postElement.style.cssText = `
                        border: 1px solid var(--border-color);
                        border-radius: var(--radius);
                        padding: 16px;
                        margin-bottom: 16px;
                        background: var(--surface-color);
                    `;
                    
                    const timeAgo = getTimeAgo(new Date(post.timestamp));
                    const avatar = post.authorPhoto ? 
                        `<img src="${post.authorPhoto}" alt="${post.authorName}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">` :
                        `<div class="user-avatar" style="width: 40px; height: 40px; font-size: 1rem;">${(post.authorName || 'U').charAt(0).toUpperCase()}</div>`;
                    
                    postElement.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            ${avatar}
                            <div>
                                <strong>${post.authorName}</strong>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">${timeAgo}</div>
                            </div>
                        </div>
                        <div style="margin-bottom: 12px; line-height: 1.6;">
                            ${post.text}
                        </div>
                        <div style="display: flex; gap: 16px; font-size: 0.9rem; color: var(--text-secondary);">
                            <span style="cursor: pointer;" onclick="likePost('${post.id}')">👍 Like (${post.likes || 0})</span>
                            <span style="cursor: pointer;">💬 Comment</span>
                        </div>
                    `;
                    
                    container.appendChild(postElement);
                });
                
            } catch (error) {
                console.error('Error loading social feed:', error);
            }
        }

        async function likePost(postId) {
            try {
                await database.ref(`posts/${postId}/likes`).transaction((likes) => {
                    return (likes || 0) + 1;
                });
                showNotification('Liked! 👍', 'success');
            } catch (error) {
                console.error('Error liking post:', error);
            }
        }

        // Analytics Functions
        function updateConsistencyScore() {
            if (!userData.checkIns) {
                document.getElementById('consistencyScore').textContent = '0%';
                return;
            }
            
            const last30Days = [];
            const today = new Date();
            
            for (let i = 0; i < 30; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                last30Days.push(date.toDateString());
            }
            
            const activeDays = last30Days.filter(dateString => {
                const dayCheckIns = userData.checkIns[dateString];
                return dayCheckIns && Object.keys(dayCheckIns).length > 0;
            }).length;
            
            const consistencyPercentage = Math.round((activeDays / 30) * 100);
            document.getElementById('consistencyScore').textContent = consistencyPercentage + '%';
        }

        function updateProgressCharts() {
            // Simple chart implementation using Canvas
            // In a real app, you'd use a charting library like Chart.js
            
            if (!userData.progressData || userData.progressData.length === 0) return;
            
            const weightData = Object.values(userData.progressData)
                .filter(entry => entry.weight)
                .slice(-30); // Last 30 entries
            
            drawSimpleChart('weightChart', weightData.map(entry => entry.weight), 'Weight (kg)');
        }

        function drawSimpleChart(canvasId, data, label) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            
            if (data.length === 0) {
                ctx.fillStyle = '#9ca3af';
                ctx.font = '14px Inter';
                ctx.textAlign = 'center';
                ctx.fillText('No data available', width / 2, height / 2);
                return;
            }
            
            const max = Math.max(...data);
            const min = Math.min(...data);
            const range = max - min || 1;
            
            // Draw grid
            ctx.strokeStyle = '#e5e7eb';
            ctx.lineWidth = 1;
            
            for (let i = 0; i < 5; i++) {
                const y = (height / 4) * i;
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();
            }
            
            // Draw line
            ctx.strokeStyle = '#3b82f6';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            data.forEach((value, index) => {
                const x = (width / (data.length - 1)) * index;
                const y = height - ((value - min) / range) * height;
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            
            ctx.stroke();
            
            // Draw points
            ctx.fillStyle = '#3b82f6';
            data.forEach((value, index) => {
                const x = (width / (data.length - 1)) * index;
                const y = height - ((value - min) / range) * height;
                
                ctx.beginPath();
                ctx.arc(x, y, 3, 0, 2 * Math.PI);
                ctx.fill();
            });
        }

        // Utility Functions
        function getTimeAgo(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
            return `${Math.floor(diffInSeconds / 86400)}d ago`;
        }

        function showTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            
            // Load tab-specific data
            if (tabName === 'social') {
                loadSocialFeed();
            } else if (tabName === 'progress') {
                updateProgressCharts();
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Global Progress Updates
        function updateGlobalProgress() {
            const startDate = new Date('2025-06-01');
            const endDate = new Date('2026-06-01');
            const currentDate = new Date();
            
            const totalDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
            const completedDays = Math.ceil((currentDate - startDate) / (1000 * 60 * 60 * 24));
            const remainingDays = Math.max(0, totalDays - completedDays);
            
            const percentage = Math.max(0, Math.min(100, (completedDays / totalDays) * 100));
            
            document.getElementById('globalProgress').textContent = `Progress: ${percentage.toFixed(1)}%`;
            document.getElementById('daysRemaining').textContent = `Days left: ${remainingDays}`;
        }

        // Page Visibility API for online status
        document.addEventListener('visibilitychange', () => {
            if (currentUser) {
                updateUserOnlineStatus(!document.hidden);
            }
        });

        // Handle page unload
        window.addEventListener('beforeunload', () => {
            if (currentUser) {
                updateUserOnlineStatus(false);
            }
        });

        // Initialize the application
        function initializeApp() {
            if (initializeFirebase()) {
                updateGlobalProgress();
                
                // Update global progress every hour
                setInterval(updateGlobalProgress, 3600000);
                
                console.log('✅ FitSquad Pro initialized successfully');
            } else {
                showNotification('Firebase configuration required', 'error');
            }
        }

    </script>
</body>
</html>
